<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Importaci√≥n de Productos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

    <div class="container py-5">

        <h1 class="mb-4 text-center text-primary fw-bold">Importaci√≥n de Productos</h1>

        <!-- Mensajes globales -->
        <div th:if="${error}" class="alert alert-danger text-center" th:text="${error}"></div>
        <div th:if="${mensaje}" class="alert alert-success text-center" th:text="${mensaje}"></div>

        <!-- Secci√≥n: Subida de archivos -->
        <div class="card mb-5 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Cargar archivo Excel y sus im√°genes</h5>
                <p class="card-text text-muted mb-3">Descarg√° la plantilla base y luego sub√≠ el Excel completo junto a
                    las im√°genes correspondientes.</p>

                <div class="mb-3">
                    <a class="btn btn-outline-primary" th:href="@{/importacion-productos/descargar-excel}">
                        üì• Descargar plantilla Excel
                    </a>
                </div>

                <form th:action="@{/importacion-productos/subir-excel}" method="post" enctype="multipart/form-data">
                    <div class="row g-3 align-items-center">
                        <div class="col-md-5">
                            <label class="form-label">Archivo Excel (.xlsx)</label>
                            <input type="file" name="archivoExcel" accept=".xlsx" class="form-control" required>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Im√°genes de productos</label>
                            <input type="file" name="imagenes" multiple accept="image/*" class="form-control" required>
                        </div>
                        <div class="col-md-2 text-center">
                            <button type="submit" class="btn btn-success w-100 mt-4">Subir</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Secci√≥n: Resultados de validaci√≥n -->
        <div th:if="${productosWrapper}" class="card shadow-sm mb-5">
            <div class="card-body">
                <h5 class="card-title text-center mb-4">Resultados de Validaci√≥n</h5>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-primary text-center">
                            <tr>
                                <th>Nombre</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Nombre Imagen</th>
                                <th>Preview Imagen</th>
                                <th>Estado</th>
                                <th>Advertencias</th>
                                <th>Errores</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="producto : ${productosWrapper.productos}">
                                <td th:text="${producto.nombre}"></td>
                                <td th:text="${producto.precio}"></td>
                                <td th:text="${producto.stock}"></td>
                                <td th:text="${producto.nombreImagen}"></td>
                                <td class="text-center">
                                    <span th:if="${imagenesTemporales[__${productoStat.index}__] == null}">No
                                        cargada</span>
                                    <img th:if="${imagenesTemporales[__${productoStat.index}__] != null}"
                                        th:src="@{${imagenesTemporales[__${productoStat.index}__]}}" alt="preview"
                                        class="img-thumbnail" style="width:80px; height:80px;">
                                </td>

                                <td class="text-center">
                                    <span th:if="${producto.valido}" class="badge bg-success">‚úÖ V√°lido</span>
                                    <span th:if="${!producto.valido and #strings.isEmpty(producto.error)}"
                                        class="badge bg-warning text-dark">‚ö†Ô∏è Con Advertencias</span>
                                    <span th:if="${!producto.valido and !#strings.isEmpty(producto.error)}"
                                        class="badge bg-danger">‚ùå Inv√°lido</span>
                                </td>
                                <td>
                                    <span th:text="${producto.advertencia}" th:if="${producto.advertencia}"></span>
                                </td>
                                <td>
                                    <span th:text="${producto.error}" th:if="${producto.error}"></span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div th:if="${productosWrapper}" class="card shadow-sm mb-5">
                    <div class="card-body">
                        <div class="text-center mt-4">
                            <form th:action="@{/importacion-productos/confirmar}" method="post">

                                <input type="hidden" name="sessionId" th:value="${sessionId}" />

                                <input type="hidden" th:each="img : ${imagenesTemporales}" th:name="imagenesTemporales"
                                    th:value="${img}" />

                                <button type="submit" class="btn btn-primary px-4">Confirmar Importaci√≥n</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n: Listas de referencia -->
        <div class="row text-center">
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white">Colores Disponibles</div>
                    <ul class="list-group list-group-flush">
                        <li th:each="color : ${colores}" class="list-group-item" th:text="${color.nombre}"></li>
                    </ul>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white">Tipos de Producto</div>
                    <ul class="list-group list-group-flush">
                        <li th:each="tipo : ${tiposProducto}" class="list-group-item" th:text="${tipo.nombre}"></li>
                    </ul>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white">Marcas Registradas</div>
                    <ul class="list-group list-group-flush">
                        <li th:each="marca : ${marcas}" class="list-group-item" th:text="${marca.nombre}"></li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

</body>

</html>