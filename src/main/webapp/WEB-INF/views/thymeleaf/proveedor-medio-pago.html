<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
    <meta charset="UTF-8">
    <title>Medios de Pago</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/medio-pago.css}" />
    <link rel="stylesheet" th:href="@{/css/dashboard-proveedor.css}" />
</head>

<body>
    <div style="min-height: 100vh;">
        <div th:replace="sidebar :: sidebar"></div>

        <div class="main" id="mainContent">
            <div class="header row align-items-center mb-4">
                <div class="col-12 col-md-8 mb-2 mb-md-0">
                    <h2 class="mb-4"><i class="bi bi-credit-card"></i> Medios de Pago</h2>
                </div>
                <div class="col-12 col-md-4 d-flex align-items-center justify-content-md-end">
                    <div class="profile-section position-relative" id="profileMenuContainer">
                        <button id="profileToggle" class="d-flex align-items-center bg-transparent border-0 p-0"
                            aria-haspopup="true" aria-expanded="false" aria-controls="profileDropdown"
                            title="Opciones de usuario">
                           <img th:src="${fotoPerfil}" alt="Proveedor" class="profile-img me-2">
                                
                            <div class="profile-info text-start">
                                <h3 class="mb-0 fs-6"><span th:text="${mailProveedor}"></span></h3>
                                <p class="mb-0 text-muted small">PROVEEDOR</p>
                            </div>
                            <i class="ms-2 bi bi-caret-down-fill text-light small"></i>
                        </button>

                        <div id="profileDropdown" class="profile-dropdown shadow" role="menu" aria-hidden="true">
                            <a class="profile-dropdown-item" th:href="@{/usuarios/perfil-usuario}" role="menuitem">
                                <i class="bi bi-person-circle me-2"></i> Mi Perfil
                            </a>
                            <a class="profile-dropdown-item" th:href="@{/logout}" role="menuitem">
                                <i class="bi bi-box-arrow-right me-2"></i> Cerrar sesi√≥n
                            </a>
                        </div>
                    </div>
                </div>
            </div>




            <div class="row g-4">
                <!-- ============================
             LISTADO DE MEDIOS DISPONIBLES
             ============================ -->
                <div class="col-md-6">
                    <h4>Disponibles</h4>

                    <div class="list-group">

                        <div th:each="medio : ${mediosDisponibles}" class="list-group-item medio-item"
                            th:id="'medio-' + ${medio.id}"
                            th:classappend="${#lists.contains(mediosProveedor, medio)} ? 'seleccionado medio-seleccionado'">

                            <div class="medio-item d-flex align-items-center justify-content-between"
                                id="medio-[[${medio.id}]]" th:onclick="'toggleMedio(' + ${medio.id} + ')'">

                                <!-- Columna izquierda -->
                                <div class="d-flex align-items-center">
                                    <img th:src="@{/img/{file}(file=${medio.imagen})}" class="icono-medio" alt="icono">

                                    <div class="ms-2">
                                        <strong th:text="${medio.nombre}"></strong><br />
                                        <small th:text="'Tipo: ' + ${medio.tipo}"></small>
                                    </div>
                                </div>

                                <!-- Columna derecha: Cuotas -->
                                <div th:if="${medio.tipo == T(com.tallerwebi.dominio.enums.TipoMedioPago).CREDITO}">
                                    <span class="badge rounded-pill bg-warning text-dark px-3 py-2"
                                        th:text="'Cuotas: ' + ${medio.cantidad_cuotas}">
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================
             PANEL DE MEDIOS SELECCIONADOS
             ============================ -->
                <div class="col-md-6">
                    <h4>Medios de pago seleccionados</h4>

                    <div id="panelSeleccionados">

                        <!-- Se agrupan por tipo -->
                        <div th:each="tipo : ${T(com.tallerwebi.dominio.enums.TipoMedioPago).values()}"
                            class="grupo-tipo">

                            <h5 th:text="${tipo}"></h5>

                            <ul th:id="'grupo-' + ${tipo}" class="list-unstyled ms-3">

                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <form method="post" th:action="@{/proveedor/guardar-medios-pago}" id="formMedios">
                <input type="hidden" name="mediosPagoIds" id="mediosPagoIds">
                <button class="btn btn-primary mt-4">Guardar Cambios</button>
            </form>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:src="@{/js/perfil-menu.js}"></script>
    <script>
        // Set inicial desde el backend
        let seleccionados = new Set([
            /* Thymeleaf convierte los IDs en JS autom√°ticamente */
            /* Ej: 1, 3, 5 */
            /* Solo IDs existentes */
            /* Esto genera: new Set([1, 3, 5]) */
            /* ---------- */
            /* Lista generada din√°micamente */
            /* ---------- */
            /* th:utext crea el array JS */
        ]);
    </script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        seleccionados = new Set(/*[[${idsMediosProveedor}]]*/);
        /*]]>*/
    </script>

    <script>



        function toggleMedio(id) {

            const item = document.getElementById("medio-" + id);

            if (item.classList.contains("seleccionado")) {
                // Deseleccionar
                item.classList.remove("seleccionado");
                seleccionados.delete(id); // üî• IMPORTANTE
                quitarDelPanel(id);
            } else {
                // Seleccionar
                item.classList.add("seleccionado");
                seleccionados.add(id);
                agregarAlPanel(id);
            }

            actualizarHidden();
        }

        function agregarAlPanel(id) {

            // Evitar duplicados
            if (document.getElementById("sel-" + id)) {
                return;
            }

            const nombre = document.querySelector("#medio-" + id + " strong").innerText;
            const tipo = document.querySelector("#medio-" + id + " small").innerText.replace("Tipo: ", "");

            const cuotasElem = document.querySelector("#medio-" + id + " .badge");
            const cuotas = cuotasElem ? cuotasElem.innerText : "";

            const grupo = document.getElementById("grupo-" + tipo);

            const li = document.createElement("li");
            li.id = "sel-" + id;
            li.classList.add("medio-seleccionado", "fade-in");

            li.innerHTML = `‚úîÔ∏è <span>${cuotas ? `${nombre} (${cuotas})` : nombre}</span>`;


            grupo.appendChild(li);
        }


        function quitarDelPanel(id) {
            const li = document.getElementById("sel-" + id);
            if (li) li.remove();
        }


        function actualizarHidden() {
            document.getElementById("mediosPagoIds").value = Array.from(seleccionados).join(",");
        }

        // Render inicial: agregar los seleccionados al panel
        window.onload = function () {
            seleccionados.forEach(id => agregarAlPanel(id));
            actualizarHidden();
        };
    </script>
    <script>
        // Detectar par√°metros en la URL
        const params = new URLSearchParams(window.location.search);

        if (params.has("exito")) {
            Swal.fire({
                icon: 'success',
                title: '¬°Guardado exitoso!',
                text: 'Los medios de pago fueron actualizados correctamente.',
                confirmButtonColor: '#3085d6'
            });
        }

        if (params.has("error")) {
            Swal.fire({
                icon: 'error',
                title: 'Error al guardar',
                text: 'No se pudo actualizar los medios de pago.',
                confirmButtonColor: '#d33'
            });
        }
    </script>




</body>

</html>