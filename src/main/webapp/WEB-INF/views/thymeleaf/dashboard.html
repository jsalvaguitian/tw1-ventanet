<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ventanet Dashboard</title>
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}" />
</head>
<body>
<nav class="navbar d-md-none px-3" style="box-shadow:0 2px 8px rgba(0,0,0,0.04);">
    <span class="navbar-title">Ventanet</span>
    <button class="hamburger btn me-2" id="menuBtn">&#9776;</button>
    <div class="dropdown" id="dropdownMenu" style="display:none;position:absolute;top:56px;left:0;width:100%;z-index:1200;">
        <div class="desplegable shadow p-2">
            <a class="dropdown-item active" href="#">Dashboard</a>
        </div>
    </div>
</nav>

<div class="sidebar" id="sidebar">
    <h2>Ventanet</h2>
    <ul>
        <li class="active">Dashboard</li>
    </ul>
</div>

<div class="main" id="mainContent">
    <div class="header row align-items-center mb-4">
        <!-- Buscador -->
        <div class="col-12 col-md-8 mb-2 mb-md-0">
            <input type="text" class="form-control" placeholder="Buscar por cotización, Ubicación, Fecha, etc." id="searchInput">
        </div>
        <div class="col-12 col-md-4 d-flex align-items-center justify-content-md-end">
            <div class="profile-section">
                <img src="https://images.unsplash.com/photo-1559839734-2b71ea197ec2?w=100&h=100&fit=crop&crop=face"
                     alt="Cliente" class="profile-img">
                <div class="profile-info">
                    <h3><span th:text="${apellidoCliente}"></span>, <span th:text="${nombreCliente}"></span></h3>
                    <p><span th:text="${rolCliente}"></span></p>
                </div>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="stats mt-3 mb-3 d-flex justify-content-around">
            <div class="stat text-center">
                <span class="number" th:text="${cotizaciones.size()}"></span><br>
                <span class="label">Total de Cotizaciones</span>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters mb-3 d-flex flex-wrap align-items-center">
            <select id="dateFilter" class="form-select w-auto me-2 mb-2 mb-md-0">
                <option value="all">Todos</option>
                <option value="today">Hoy</option>
                <option value="yesterday">Ayer</option>
                <option value="last7">Últimos 7 días</option>
                <option value="last30">Últimos 30 días</option>
                <option value="month">Este Mes</option>
            </select>
            <button id="applyFilter" class="btn btn-primary me-2 mb-2 mb-md-0">Aplicar</button>
            <button class="btn btn-success mb-2 mb-md-0">Crear Cotización</button>
        </div>
    </div>

    <!-- Grilla de cotizaciones -->
  <div class="events-table">
                    <div id="eventsGrid" class="events-grid"></div>
    </div>
</div>

<!-- Modal para detalles -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle de la Cotización</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Se llenará dinámicamente -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
/*<![CDATA[*/
var events = /*[[${cotizaciones}]]*/ [];
events = events.map(ev => ({
    nombre: ev.nombre,
    cantidad: ev.cantidad,
    ubicacion: ev.ubicacion,
    alto: ev.alto,
    ancho: ev.ancho,
    color: ev.color,
    fechaCotizacion: new Date(ev.fechaCotizacion.year, ev.fechaCotizacion.monthValue - 1, ev.fechaCotizacion.dayOfMonth).toLocaleDateString('es-ES')
}));

function renderGrid(list) {
    const grid = document.getElementById('eventsGrid');
    grid.innerHTML = '';
    list.forEach((c, i) => {
        grid.innerHTML += `
        <div class='event-card col-12 col-sm-6 col-lg-4 mb-3'>
            <div class='event-header'>Cotización #${i+1}</div>
            <div class='event-body'>
                <div><strong>Nombre:</strong> ${c.nombre}</div>
                <div><strong>Cantidad:</strong> ${c.cantidad}</div>
                <div><strong>Dimensión:</strong> ${c.alto} x ${c.ancho}</div>
                <div><strong>Color:</strong> ${c.color}</div>
                <div><strong>Ubicación:</strong> ${c.ubicacion}</div>
                <div><strong>Fecha:</strong> ${c.fechaCotizacion}</div>
            </div>
            <div class='event-actions'>
                <button class='action-btn btn btn-primary' data-index='${i}' data-bs-toggle='modal' data-bs-target='#eventModal'>Ver</button>
            </div>
        </div>`;
    });
}

// Inicializar grilla
renderGrid(events);

// Buscador
document.getElementById('searchInput').addEventListener('input', function() {
    const query = this.value.toLowerCase();
    const filtered = events.filter(ev =>
        (ev.nombre && ev.nombre.toLowerCase().includes(query)) ||
        (ev.ubicacion && ev.ubicacion.toLowerCase().includes(query)) ||
        (ev.color && ev.color.toLowerCase().includes(query))
    );
    renderGrid(filtered);
});

// Filtro de fechas
document.getElementById('applyFilter').onclick = function() {
    const filter = document.getElementById('dateFilter').value;
    const today = new Date();
    function parseDate(str) {
        if (!str) return new Date();
        const parts = str.split(/[-\/]/);
        return (parts[0].length === 4) ? new Date(parts[0], parts[1]-1, parts[2]) : new Date(parts[2], parts[1]-1, parts[0]);
    }
    let filtered = events;

    if (filter === 'today') {
        filtered = events.filter(ev => parseDate(ev.fechaCotizacion).toDateString() === today.toDateString());
    } else if (filter === 'yesterday') {
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        filtered = events.filter(ev => parseDate(ev.fechaCotizacion).toDateString() === yesterday.toDateString());
    } else if (filter === 'last7') {
        const weekAgo = new Date(today);
        weekAgo.setDate(today.getDate() - 7);
        filtered = events.filter(ev => {
            const d = parseDate(ev.fechaCotizacion);
            return d >= weekAgo && d <= today;
        });
    } else if (filter === 'last30') {
        const monthAgo = new Date(today);
        monthAgo.setDate(today.getDate() - 30);
        filtered = events.filter(ev => {
            const d = parseDate(ev.fechaCotizacion);
            return d >= monthAgo && d <= today;
        });
    } else if (filter === 'month') {
        filtered = events.filter(ev => {
            const d = parseDate(ev.fechaCotizacion);
            return d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear();
        });
    }
    renderGrid(filtered);
};

// Modal: mostrar detalles
document.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('action-btn')){
        const idx = e.target.getAttribute('data-index');
        const c = events[idx];
        const body = document.getElementById('eventModalBody');
        body.innerHTML = `
            <p><strong>Nombre:</strong> ${c.nombre}</p>
            <p><strong>Cantidad:</strong> ${c.cantidad}</p>
            <p><strong>Dimensión:</strong> ${c.alto} x ${c.ancho}</p>
            <p><strong>Color:</strong> ${c.color}</p>
            <p><strong>Ubicación:</strong> ${c.ubicacion}</p>
            <p><strong>Fecha:</strong> ${c.fechaCotizacion}</p>
        `;
    }
});
/*]]>*/

</script>
</body>
</html>
